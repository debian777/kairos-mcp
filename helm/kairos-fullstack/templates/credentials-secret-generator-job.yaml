{{- if and .Values.credentials.autoGenerate (not .Values.credentials.existingSecret) }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-credentials-generator
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 5
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: {{ .Release.Name }}-credentials-generator
      containers:
        - name: generate
          image: bitnami/kubectl:latest
          command:
            - /bin/sh
            - -ec
            - |
              SECRET_NAME="{{ .Values.credentials.name }}"
              NAMESPACE="{{ .Release.Namespace }}"
              if kubectl get secret "$SECRET_NAME" -n "$NAMESPACE" 2>/dev/null; then
                echo "Secret $SECRET_NAME already exists, skipping generation"
                exit 0
              fi
              echo "Creating secret $SECRET_NAME with generated passwords (stored only in K8s)"
              kubectl create secret generic "$SECRET_NAME" -n "$NAMESPACE" \
                --from-literal=redis-password=$(openssl rand -base64 32) \
                --from-literal=keycloak-db-password=$(openssl rand -base64 32) \
                --from-literal=session-secret=$(openssl rand -base64 32)
              echo "Done"
          securityContext:
            runAsNonRoot: true
            runAsUser: 1001
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
{{- end }}
