{{- if or .Values.redisCluster.enabled .Values.keycloakInstance.enabled .Values.postgresCluster.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-operator-precheck
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-15"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
data:
  REDIS_CHECK: {{ .Values.redisCluster.enabled | quote }}
  KEYCLOAK_CHECK: {{ .Values.keycloakInstance.enabled | quote }}
  POSTGRES_CHECK: {{ .Values.postgresCluster.enabled | quote }}
  check.sh: |
    set -e
    echo "KAIROS operator pre-check: verifying required CRDs..."
    missing=""
    if [ "$REDIS_CHECK" = "true" ]; then
      if kubectl get crd redisfailovers.databases.spotahome.com &>/dev/null; then
        echo "  OK: Redis operator (redisfailovers.databases.spotahome.com)"
      else
        missing="$missing redisfailovers.databases.spotahome.com (Redis / Spotahome redis-operator)"
      fi
    fi
    if [ "$KEYCLOAK_CHECK" = "true" ]; then
      if kubectl get crd keycloaks.k8s.keycloak.org &>/dev/null; then
        echo "  OK: Keycloak operator (keycloaks.k8s.keycloak.org)"
      else
        missing="$missing keycloaks.k8s.keycloak.org (Keycloak operator)"
      fi
    fi
    if [ "$POSTGRES_CHECK" = "true" ]; then
      if kubectl get crd perconapgclusters.pgv2.percona.com &>/dev/null; then
        echo "  OK: Percona PostgreSQL operator (perconapgclusters.pgv2.percona.com)"
      else
        missing="$missing perconapgclusters.pgv2.percona.com (Percona PostgreSQL operator)"
      fi
    fi
    if [ -n "$missing" ]; then
      echo "Missing CRDs:$missing"
      echo "Install the operators first (see docs/OPERATORS.md). Then re-run helm install."
      exit 1
    fi
    echo "Operator pre-check passed."
{{- end }}
