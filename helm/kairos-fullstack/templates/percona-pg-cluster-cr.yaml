{{- if and .Values.postgresCluster.enabled (not .Values.postgresCluster.useOwnCluster) }}
{{- $spec := default dict .Values.postgresCluster.customSpec }}
{{- if not (kindIs "map" $spec) }}
{{- $_ := fail "postgresCluster.customSpec must be a map (object)" }}
{{- end }}
apiVersion: pgv2.percona.com/v2
kind: PerconaPGCluster
metadata:
  name: {{ .Values.postgresCluster.name }}
  namespace: {{ .Values.postgresCluster.namespace | default .Release.Namespace }}
  labels:
    app.kubernetes.io/part-of: kairos-fullstack
    app.kubernetes.io/managed-by: {{ .Release.Service }}
spec:
  {{- if empty $spec }}
  instances:
    - name: instance1
      replicas: {{ .Values.postgresCluster.instances }}
      dataVolumeClaimSpec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: {{ .Values.postgresCluster.storageSize }}
  proxy:
    pgBouncer:
      replicas: 2
  {{- else }}
  {{- toYaml $spec | nindent 2 }}
  {{- end }}
{{- end }}
