# Integration tests with Docker infra (Redis, Qdrant, Postgres, Keycloak). AUTH enabled.
# Manual trigger only for testing; switch to push/PR when ready.
# Secrets: OPENAI_API_KEY (from GitHub secrets). Infra/dev secrets are generated by the script each run.
# See .github/workflows/README.md for gh secret/variable setup.
name: Integration

on:
  workflow_dispatch:

jobs:
  integration:
    name: Infra + dev deploy + integration tests (AUTH on)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"

      - name: Generate .env and .env.dev (infra + app config)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: python3 scripts/generate_dev_secrets.py


      - name: Verify .env and .env.dev exist
        run: ls -la .env .env.dev && cat .env.dev .env

      # --- DEBUG: which env vars are available (secrets: empty vs non-empty only) ---
      - name: Debug env and .env.dev keys
        run: |
          echo "=== Env var names set in job (sorted) ==="
          env | sed 's/=.*/=***/' | sort
          echo ""
          echo "=== .env.dev keys (values redacted) ==="
          [ -f .env.dev ] && sed -E 's/^([^#=]+)=.*/\1=***/' .env.dev | grep -v '^#' | grep '=' || echo "(no .env.dev or no KEY=value lines)"
          echo ""
          echo "=== QDRANT_COLLECTION value in .env.dev (not a secret) ==="
          [ -f .env.dev ] && (grep -E '^QDRANT_COLLECTION=' .env.dev || echo "QDRANT_COLLECTION not found in .env.dev")
          echo ""
          echo "=== Secrets (empty vs non-empty only) ==="
          for k in OPENAI_API_KEY SESSION_SECRET QDRANT_API_KEY KEYCLOAK_ADMIN_PASSWORD KEYCLOAK_DB_PASSWORD; do
            v="${!k:-}"
            if [ -z "$v" ]; then echo "${k}=<empty>"; else echo "${k}=<non-empty>"; fi
          done
          echo ""
          echo "=== Other key vars (set vs unset) ==="
          for k in REDIS_URL QDRANT_URL QDRANT_COLLECTION QDRANT_COLLECTION_CURRENT AUTH_ENABLED KEYCLOAK_URL; do
            if [ -n "${!k+x}" ]; then echo "${k}=<set>"; else echo "${k}=<unset>"; fi
          done

      - name: Restore infra Docker image cache
        uses: actions/cache/restore@v4
        id: docker-infra-cache
        with:
          path: .cache/docker-infra
          key: infra-docker-${{ hashFiles('compose.yaml') }}

      - name: Load infra Docker images from cache
        if: steps.docker-infra-cache.outputs.cache-hit == 'true'
        run: docker load -i .cache/docker-infra/images.tar

      - name: Start Docker infra
        run: docker compose --env-file .env.dev --profile infra up -d

      - name: Save infra Docker images for cache
        if: steps.docker-infra-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p .cache/docker-infra
          docker save -o .cache/docker-infra/images.tar \
            redis:7-alpine \
            qdrant/qdrant:latest \
            postgres:16 \
            quay.io/keycloak/keycloak:26.5.4

      - name: Cache infra Docker images
        uses: actions/cache/save@v4
        if: steps.docker-infra-cache.outputs.cache-hit != 'true'
        with:
          path: .cache/docker-infra
          key: infra-docker-${{ hashFiles('compose.yaml') }}

      - name: Wait for Redis
        run: |
          for i in $(seq 1 30); do
            docker compose --env-file .env.dev --profile infra exec -T redis redis-cli ping 2>/dev/null | grep -q PONG && break
            [ $i -eq 30 ] && exit 1
            sleep 2
          done

      - name: Wait for Qdrant
        run: |
          for i in $(seq 1 30); do
            curl -sSf http://127.0.0.1:6333/healthz >/dev/null && break
            [ $i -eq 30 ] && exit 1
            sleep 2
          done

      - name: Wait for Postgres
        run: |
          for i in $(seq 1 30); do
            docker compose --env-file .env.dev --profile infra exec -T postgres pg_isready -U keycloak -d keycloak 2>/dev/null && break
            [ $i -eq 30 ] && exit 1
            sleep 2
          done

      - name: Wait for Keycloak
        run: |
          for i in $(seq 1 90); do
            curl -sSf -o /dev/null http://localhost:9000/health/ready && break
            [ $i -eq 90 ] && exit 1
            sleep 2
          done

      - name: Configure Keycloak realms and test user
        run: python3 scripts/configure-keycloak-realms.py

      - name: Install dependencies
        run: npm ci

      - name: Deploy dev and run auth integration test
        env:
          HEALTH_CHECK_ATTEMPTS: 90
        run: |
          npm run dev:deploy || true
          npm run dev:test -- tests/integration/auth-keycloak.test.ts || {
            echo "--- .kairos-dev.log (last 200 lines) ---"
            tail -200 .kairos-dev.log 2>/dev/null || echo "(no log file)"
            exit 1
          }

      - name: Upload kairos-dev log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kairos-dev-log
          path: .kairos-dev.log
          if-no-files-found: ignore
