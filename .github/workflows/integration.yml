# Integration tests with Docker infra (Redis, Qdrant, Postgres, Keycloak). AUTH enabled.
# Manual trigger only for testing; switch to push/PR when ready.
# Secrets: OPENAI_API_KEY (from GitHub secrets). Infra/dev secrets are generated by the script each run.
# See .github/workflows/README.md for gh secret/variable setup.
name: Integration

on:
  workflow_dispatch:

jobs:
  integration:
    name: Infra + dev deploy + integration tests (AUTH on)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"

      - name: Generate .env and .env.dev (infra + app config)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: python3 scripts/generate_dev_secrets.py


      - name: Verify .env and .env.dev exist
        run: ls -la .env .env.dev && cat .env.dev .env

      - name: Restore infra Docker image cache
        uses: actions/cache/restore@v4
        id: docker-infra-cache
        with:
          path: .cache/docker-infra
          key: infra-docker-${{ hashFiles('compose.yaml') }}

      - name: Load infra Docker images from cache
        if: steps.docker-infra-cache.outputs.cache-hit == 'true'
        run: docker load -i .cache/docker-infra/images.tar

      - name: Start Docker infra
        run: docker compose --env-file .env.dev --profile infra up -d

      - name: Save infra Docker images for cache
        if: steps.docker-infra-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p .cache/docker-infra
          docker save -o .cache/docker-infra/images.tar \
            redis:7-alpine \
            qdrant/qdrant:latest \
            postgres:16 \
            quay.io/keycloak/keycloak:26.5.4

      - name: Cache infra Docker images
        uses: actions/cache/save@v4
        if: steps.docker-infra-cache.outputs.cache-hit != 'true'
        with:
          path: .cache/docker-infra
          key: infra-docker-${{ hashFiles('compose.yaml') }}

      - name: Wait for Redis
        run: |
          for i in $(seq 1 30); do
            docker compose --env-file .env.dev --profile infra exec -T redis redis-cli ping 2>/dev/null | grep -q PONG && break
            [ $i -eq 30 ] && exit 1
            sleep 2
          done

      - name: Wait for Qdrant
        run: |
          for i in $(seq 1 30); do
            curl -sSf http://127.0.0.1:6333/healthz >/dev/null && break
            [ $i -eq 30 ] && exit 1
            sleep 2
          done

      - name: Wait for Postgres
        run: |
          for i in $(seq 1 30); do
            docker compose --env-file .env.dev --profile infra exec -T postgres pg_isready -U keycloak -d keycloak 2>/dev/null && break
            [ $i -eq 30 ] && exit 1
            sleep 2
          done

      - name: Wait for Keycloak
        run: |
          for i in $(seq 1 90); do
            curl -sSf -o /dev/null http://localhost:9000/health/ready && break
            [ $i -eq 90 ] && exit 1
            sleep 2
          done

      - name: Configure Keycloak realms and test user
        run: python3 scripts/configure-keycloak-realms.py

      - name: Install dependencies
        run: npm ci

      - name: Deploy dev and run auth integration test
        env:
          HEALTH_CHECK_ATTEMPTS: 15
        run: |
          npm run dev:deploy
          source .env
          source .env.dev 
          npm run dev:test -- tests/integration/auth-keycloak.test.ts

      - name: Upload kairos-dev log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kairos-dev-log
          path: .kairos-dev.log
          if-no-files-found: ignore
