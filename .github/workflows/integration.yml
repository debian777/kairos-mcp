# Integration tests with Docker infra (Redis, Qdrant, Postgres, Keycloak). AUTH enabled.
# Manual trigger only for testing; switch to push/PR when ready.
# Secrets: OPENAI_API_KEY (optional), KEYCLOAK_ADMIN_PASSWORD / KEYCLOAK_DB_PASSWORD (optional overrides).
# See .github/workflows/README.md for gh secret/variable setup.
name: Integration (manual)

on:
  workflow_dispatch:

jobs:
  integration:
    name: Infra + dev deploy + integration tests (AUTH on)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"

      - name: Create .env.dev for CI (AUTH enabled)
        env:
          KEYCLOAK_ADMIN_PASSWORD: ${{ secrets.KEYCLOAK_ADMIN_PASSWORD != '' && secrets.KEYCLOAK_ADMIN_PASSWORD || 'ci-keycloak-admin' }}
          KEYCLOAK_DB_PASSWORD: ${{ secrets.KEYCLOAK_DB_PASSWORD != '' && secrets.KEYCLOAK_DB_PASSWORD || 'ci-keycloak-db' }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
        run: |
          cp env.example.txt .env.dev
          echo "REDIS_URL=redis://127.0.0.1:6379" >> .env.dev
          echo "QDRANT_URL=http://127.0.0.1:6333" >> .env.dev
          echo "AUTH_ENABLED=true" >> .env.dev
          echo "KEYCLOAK_URL=http://localhost:8080" >> .env.dev
          echo "KEYCLOAK_REALM=kairos-dev" >> .env.dev
          echo "KEYCLOAK_CLIENT_ID=kairos-mcp" >> .env.dev
          echo "AUTH_CALLBACK_BASE_URL=http://localhost:3300" >> .env.dev
          if [ -n "$SESSION_SECRET" ]; then
            echo "SESSION_SECRET=$SESSION_SECRET" >> .env.dev
          else
            echo "SESSION_SECRET=$(openssl rand -hex 32)" >> .env.dev
          fi
          echo "KEYCLOAK_ADMIN_PASSWORD=$KEYCLOAK_ADMIN_PASSWORD" >> .env.dev
          echo "KEYCLOAK_DB_PASSWORD=$KEYCLOAK_DB_PASSWORD" >> .env.dev
          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env.dev
          fi
          cp .env.dev .env

      - name: Start Docker infra
        run: docker compose --env-file .env.dev --profile infra up -d

      - name: Wait for Redis
        run: |
          for i in $(seq 1 30); do
            docker compose --env-file .env.dev --profile infra exec -T redis redis-cli ping 2>/dev/null | grep -q PONG && break
            [ $i -eq 30 ] && exit 1
            sleep 2
          done

      - name: Wait for Qdrant
        run: |
          for i in $(seq 1 30); do
            curl -sSf http://127.0.0.1:6333/healthz >/dev/null && break
            [ $i -eq 30 ] && exit 1
            sleep 2
          done

      - name: Wait for Keycloak
        run: |
          for i in $(seq 1 60); do
            curl -sSf -o /dev/null http://localhost:8080/health/ready && break
            [ $i -eq 60 ] && exit 1
            sleep 2
          done

      - name: Configure Keycloak realms and test user
        run: python3 scripts/configure-keycloak-realms.py

      - name: Install dependencies
        run: npm ci

      - name: Deploy dev and run integration tests
        run: npm run dev:deploy && npm run dev:test
